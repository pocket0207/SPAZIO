$(document).ready(function($) {

  //button click method
  $("#getButton").click(function() {

    var ipAddress = $('#ipAdd').val();
    console.log(ipAddress);

    var userApiKey = "W9SoBjEUUTaz2IvhHSPI8xUq1syAyBk7"
    console.log(userApiKey);

    makeURL(ipAddress, userApiKey);
    getData(ipAddress, userApiKey);

  });

  $("#clearButton").click(function() {
    pageReload();
  });
});

  //provides the user the ability to quickly reset the page
function pageReload(){
  location.reload();
};

//creates the url for the requested domain
function makeURL(ipAddress, userApiKey) {
  var base = "https://api.shodan.io/shodan/host/search?key=";
  var url = base + userApiKey + "&query=net:" + ipAddress;
  console.log(url);
  return url;
};

function getData(ipAddress, userApiKey) {
  $.ajax({
    url: makeURL(ipAddress, userApiKey),
    method: "GET",
    success: function(json) {
      processData(json);

    }
  });
}

function processData(data) {

  //exception handling check -- check to see if IP is available
  resultsLen = data['total'];
    if (resultsLen == "0"){
      $('#vulnError').html('No results found');
    }else{
      $('#vulnError').html('');
    };


  hostData = data["matches"];
  for (hostNum in hostData) {
    var hostInfo = hostData[hostNum];
    //check to see if the IP has vulnerabilities
    var vulnCheck = hostInfo.hasOwnProperty("vulns");
    if (vulnCheck === true) {
      $('#vulnError').html('');

      vulnList = [];
      vulnData = hostInfo["vulns"];
      for (vulnNum in vulnData) {
        var vulnInfo = vulnData[vulnNum];
        vulnList.push(vulnInfo);
        var cvss = vulnInfo["cvss"];
        var summary = vulnInfo["summary"];

        //build the table
        var tableRow = "<tr><td>" + vulnNum + "</td><td>" + cvss + "</td><td>" + summary + "</td></tr>"
        $("#output").append(tableRow);
      };

      //provides number of vulnerabilities found
      vLen = vulnList.length;
      let resultsLen = vLen;
      $('#resultsNum').html('Results: ' + resultsLen);

    } else {
      $('#vulnError').html('No results found');
    };
  };
};
